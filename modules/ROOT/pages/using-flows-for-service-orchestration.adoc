= Using Flows for Orchestration
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:keywords: anypoint studio, studio, mule esb, orchestration

== Introduction

A *flow* is a simple yet very flexible mechanism that enables orchestration of services using the sophisticated message flow capabilities of Mule. Using a flow, you may automate integration processes and construct Mule message processing solutions by ordering any number of elements of a Mule flow in a valid arrangement. Because what you do inside a flow is up to you as the developer, it is much easier to create solutions that match your requirements.

== When to Use a Flow

[TIP]
*A flow is the most versatile and powerful integration mechanism available in Mule.*

Flows are valuable in many situations, including:

* Simple integration tasks
* Scheduled data processing
* Connecting cloud and on-premise applications
* Event processing where multiple services need to be composed


== The Anatomy of a Flow

A flow is in essence just a chain of Mule Components. Think of each component as a Lego block where a Flow is something you build with them. A flow also has a message source, the source of messages that are processed by the component chain.

//image::flow.jpg[]

== Flow Configuration

A Flow is configured in XML using the <flow> element. Each flow has a name attribute, a message source (unless it's a private flow), one or more components and an optional error handler.

*Basic Structure*

[source,xml,linenums]
----
<flow name="">
    - 0..1 Source
    - 1..n Component(s)
    - 0..1 Error Handler
</flow>
----

Flows seem simple, yet can be quite powerful. In particular, when combined with expressions in Mule, they can allow for very sophisticated processing of the message contents. There are many elements that leverage expressions, including:

* xref:about-operations.adoc[Operations]
* xref:about-components.adoc[Core Components]
* xref:scopes-concept.adoc[Scopes]

== Example

*Simple Book Order Processing Flow*

[source,xml,linenums]
----
<flow name="orderHandling">
  <file:listener directory="/myDirectory">
    <scheduling-strategy>
      <fixed-frequency/>
    </scheduling-strategy>
    <file:matcher filenamePattern="*.xml"/>
  </file:listener>
  <ee:transform>
    <ee:message>
      <ee:set-payload resource="createBookOrdersTransformation.dwl"/>
    </ee:message>
  </ee:transform>
  <foreach collection="#[payload.orders filterObject ((value, key, index) -> value.type == 'books')]">
      <http:request method="POST" path="/book/inventory"/>
      <http:request method="POST" path="/book/order"/>
      <email:send toAddresses="#[payload.customer.email]">
        <email:body >
          <email:content ><![CDATA[#['Your order has been placed.']]]></email:content>
        </email:body>
      </email:send>
      <db:insert>
        <db:sql >INSERT INTO ORDERS(CUSTOMER, AMOUNT) VALUES (:id, :amount)</db:sql>
        <db:input-parameters><![CDATA[#[{ id : payload.customer.id, amount: payload.order.total }]]]></db:input-parameters>
      </db:insert>
    </choice>
  </foreach>
  <error-handler >
    <on-error-continue>
      <jms:publish destination="failedOrders"/>
    </on-error-continue>
  </error-handler>
</flow>
----

== Flow Behavior

When a message is received or generated by the source the flow is started and the configured components are invoked in a chain in the same order as they are configured.  Some components accept child component elements, in this case these are processed before returning and continuing processing the main list.

//image::flowrr.jpg[]

== Private Flows

A private flow is one that cannot be accessed from outside the Mule Application because it has no source defined.

Private Flows are therefore only used if they are referenced from another construct running in the same Mule Application. When configuring Mule using XML the _<flow-ref>_ element is used to include one flow in another.

A private Flow differs from the use of a "Sub Flow" in that a Flow has it's own context and error handler.

*Private Flow Example*

[source,xml,linenums]
----
<flow name="privateFlow">
  <set-payload value="b"/>
</flow>

<flow name="publicFlow">
  <http:listener path="/in" config-ref="listenerConfig"/>
  <set-payload value="a"/>
  <flow-ref name="privateFlow"/>
  <logger message="#[payload]"/>
</flow>
----

=== Reusing Logic Across Applications

When your logic needs to be shared amongst different Mule Applications, we recommend
parameterizing it and exposing it through the xref:1.1@mule-sdk::xml-sdk.adoc[XML SDK], which allows creating custom
modules. The operations exposed by these modules can contain any Mule components
within, as flows do, and are clearly parameterized and typed.


== See Also

* xref:about-flows.adoc[About Flows]
* xref:flowref-about.adoc[Flow References]
* xref:error-handling.adoc[Error Handling]
* xref:1.1@mule-sdk::xml-sdk.adoc[XML SDK]
