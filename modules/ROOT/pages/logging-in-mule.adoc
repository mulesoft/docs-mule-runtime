= Configuring Logging
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:keywords: mule, studio, logger, logs, log, notifications, errors, debug

Mule logs multiple messages and specific elements in your application flows to help you debug and keep track of events. You can also include the xref:logger-component-reference.adoc[`<logger>` Element] anywhere in a flow and set it up to output any message you want.

You can create a configuration file to define:

 * What kinds of messages to log
 * How to log the messages (asynchronously or synchronously)
 * Where to log the messages, such as to the console or disk, or to an endpoint or database.

Mule uses http:รง, which is a logging facade that discovers and uses a logging strategy from the classpath, such as https://logging.apache.org/log4j/2.x/[log4j2] or the JDK Logger. By default, Mule includes log4j2, which is configured with a file called `log4j2.xml`.

The Mule server has a `log4j2.xml` in its `conf` directory, which you can customize when running the server in standalone mode. This configuration file is relevant for data output to the `mule_ee.log` file.

If you remove the `log4j2.xml` file from your application's classpath, Mule Runtime applies a default logging configuration to the application and outputs the log to MULE_HOME/logs/<application-name>.log.

== Viewing Logs
To view Anypoint Studio logs:

. Click *Anypoint Studio* > *About Anypoint Studio* > *Installation Details* > *Configuration* tab > *View Error Log*.
+
image::logging-in-mule-view-error-log.png[View Error Log]

The output from View Error Log is in the workspace's `.metadata/.log` file, for example:
----
/Users/me/AnypointStudio/workspace/.metadata/.log
----

After you run your Mule application, the log output is in the workspace's `.mule/logs/<project>.log` file.
For example, for project `abcd`:

----
/Users/me/AnypointStudio/workspace/.mule/logs/abcd.log
----

== Synchronous Versus Asynchronous Logging

[NOTE]
By default, Mule logs messages asynchronously in version 3.6.0 and later.

When logging synchronously, the execution of the thread that is processing your message is interrupted to wait for the log message to be fully handled before it can continue:

image::logger-synch.jpg[logger+synch,align="center"]

When logging asynchronously, the logging operation occurs in a separate thread, so the message can process before the logging completes:

image::logger-asynch-alternativo.jpg[logger+asynch+alternativo,align="center"]

In most situations, it's recommended that you use *asynchronous* logging, because it substantially improves the throughput and lowers the latency of message processing.

When asynchronous logging is used and there is a system crash, some actions may not be logged. This occurs because log writing is performed on a separate thread that runs independently of other actions. Sometimes you can't avoid the action of logging something in case you need to roll back a transaction. Check the <<Exception Handling With Asynchronous Logging>> section below to see how to mitigate these issues.

If you use application logs as audit trails, configure your application to always use *synchronous* logging. This prevents the loss of any log messages.

=== Performance tests
The chart below shows the performance difference between synchronous and asynchronous logging and how much latency increased as more concurrent messages were added. In this test, an application logged about one million messages, using an increasingly higher amount of threads on each run.

image::logging-latency-vs-concurrency.png[]

The results of logging asynchronously are significantly closer to the results of not logging at all. Each transaction resulted in 1000 messages.

== Configuring Custom Logging Settings

By default, logging in Mule is done asynchronously and at a level greater than or equal to INFO. This discards log messages at the DEBUG or TRACE level.

If you need to use synchronized logging, adjust the logging level or define custom categories. You can configure these properties using the file `$MULE_HOME/conf/log4j2.xml`. This file specifies how the logger behaves. Not editing this XML file implies that you are using the default properties.

In Anypoint Studio, `log4j2.xml` appears in the `src/main/resources` path.

The default configuration defines the standard loggers as they were defined before the introduction of asynchronous logging. The only difference is that the new configuration defines all loggers (including the root logger) as asynchronous.

You can override this configuration at the domain or application level. To override this configuration at the application level, add a `logConfigFile` entry to the `mule-artiface,json` file. For example.

---
{
  "minMuleVersion": "4.0.0",

  "logConfigFile": "../../../test-classes/resources/logging/custom-log4j2.xml"
}
---

----
log.configFile=myCustomFolder/myCustomlog4j2.xml
----

If this deployment property isn't set, when an application is deployed, Mule looks for a configuration file following a child-first pattern, as listed below:

* Look for a file called `log4j2-test.xml` in the application classpath
* Look for a file called `log4j2.xml` in the application classpath
* Look for a file called `log4j2-test.xml` in the domain classpath
* Look for a file called `log4j2.xml` in the domain classpath
* Apply default configuration.


The default configuration for the `log4j2.xml` file is shown below:

*Example log4j2.xml file*

[source,xml,linenums]
----
<Configuration>
    <Appenders>
        <Console name="Console" target="SYSTEM_OUT">
            <PatternLayout pattern="%-5p %d [%t] %c: %m%n"/>
        </Console>
    </Appenders>

    <Loggers>

        <!-- CXF is used heavily by Mule for web services -->
        <AsyncLogger name="org.apache.cxf" level="WARN"/>

        <!-- Apache Commons tend to make a lot of noise which can clutter the log-->
        <AsyncLogger name="org.apache" level="WARN"/>

        <!-- Reduce startup noise -->
        <AsyncLogger name="org.springframework.beans.factory" level="WARN"/>

        <!-- Mule classes -->
        <AsyncLogger name="org.mule" level="INFO"/>
        <AsyncLogger name="com.mulesoft" level="INFO"/>

        <AsyncRoot level="INFO">
            <AppenderRef ref="Console"/>
        </AsyncRoot>
    </Loggers>

</Configuration>
----

[TIP]

== Configuring Logs for Runtime Manager Agent

[NOTE]
This configuration is only valid when using the Runtime Manager agent 1.5.2 and later.

To log your Runtime Manager Agent state in a location other than the default 'mule_agent.log' file, configure your '$MULE_HOME/conf/log4j2.xml' file to include a new Log4j2 Appender called 'mule-agent-appender'. If included, the Runtime Manager Agent plugin uses this appender to log its state.

Your `log4j2.xml` file should include something like the following snippet to enable this functionality:

[source,xml,linenums]
----
<Configuration>
    <Appenders>

      (...)

        <RollingFile name="mule-agent-appender" fileName="${env:MULE_HOME}/logs/custom_mule_agent.log" filePattern="${env:MULE_HOME}/logs/custom_mule_agent.log-%d{MM-dd-yyyy}.log.gz">
            <PatternLayout>
                <Pattern>%d %p %c{1.} [%t] %m%n</Pattern>
            </PatternLayout>
            <Policies>
                <TimeBasedTriggeringPolicy />
                <SizeBasedTriggeringPolicy size="250 MB"/>
            </Policies>
        </RollingFile>
    </Appenders>

    <Loggers>

        (...)

        <AsyncLogger name="com.mulesoft.agent" additivity="TRUE" level="ALL">
          <AppenderRef ref="mule-agent-appender" />
        </AsyncLogger>

        <AsyncRoot level="INFO">
          <AppenderRef ref="Console"/>
        </AsyncRoot>

</Configuration>
----

The above example makes the Runtime Manager agent log its state to a rolling log file in '$MULE_HOME/logs/custom_mule_agent.log'.This file rolls on a daily basis until the file reaches a 250MB size.

For other Log4j2 appender configurations, see https://logging.apache.org/log4j/2.x/manual/appenders.html.


== Exception Handling With Asynchronous Logging

If you're using asynchronous logging and experience a system crash that could have caused incomplete logs, there is an exception handler designed to help you in this situation. By default, Mule registers an LMAX `ExceptionHandler` that logs events to the disk, console, and logs/mule_ee.log`. Alternatively, you can provide your own exception handler by setting the system property `AsyncLoggerConfig.ExceptionHandler` to the canonical name of a class that implements the interface.

The default exception handler is shown below:

----
/*
 * Copyright (c) MuleSoft, Inc.  All rights reserved.  http://www.mulesoft.com
 * The software in this package is published under the terms of the CPAL v1.0
 * license, a copy of which has been included with this distribution in the
 * LICENSE.txt file.
 */
package org.mule.runtime.module.launcher.api.log4j2;

import com.lmax.disruptor.ExceptionHandler;

import org.apache.logging.log4j.status.StatusLogger;

/**
 * Implementation of {@link com.lmax.disruptor.ExceptionHandler} to be used when async loggers fail to log their messages. It will
 * log this event using the {@link org.apache.logging.log4j.status.StatusLogger}
 *
 * @since 3.6.0
 */
public class AsyncLoggerExceptionHandler implements ExceptionHandler {

  private static final StatusLogger LOGGER = StatusLogger.getLogger();

  @Override
  public void handleEventException(Throwable ex, long sequence, Object event) {
    LOGGER.error("Failed to asynchronously log message: " + event, ex);
  }

  @Override
  public void handleOnStartException(Throwable ex) {
    LOGGER.error("Failed to start asynchronous logger", ex);
  }

  @Override
  public void handleOnShutdownException(Throwable ex) {
    LOGGER.error("Failed to stop asynchronous logger", ex);
  }
}
----

There is a performance-reliability trade-off between asynchronous and synchronous logging. If the risk of losing these log messages is a serious issue, then you should configure your loggers to be synchronous. You can have a mix of both synchronous and asynchronous logging.

== Configuration Reloading

You can add or change the interval at which Mule polls modified Mule configuration files to check for changes.

Mule runtime uses log4j as the framework for logging. To add or change the monitoring interval at which log4j checks for changes, add the `monitorInterval` to the `log4j2.xml` configuration file.

. In the Mule installation folder, open `conf/log4j2.xml`.
. Add `<Configuration monitorInterval="15">` after the first line, for example:
+
[source,xml,linenums]
----
<?xml version="1.0" encoding="UTF-8"?>
<Configuration monitorInterval="15">
    <Appenders>
       <Console name="Console" target="SYSTEM_OUT">
           <PatternLayout pattern="%-5p %d [%t] %c: %m%n"/>
       </Console>
    </Appenders>
...
----
+
This example makes log4j check for changes every 15 seconds.
+
. Save the file, and restart the Mule server.

For more information, check for "Automatic Reconfiguration" in  https://logging.apache.org/log4j/2.x/manual/configuration.html[Log4j Configuration].

[source,xml,linenums]
----
<AsyncLogger name="org.glassfish.grizzly" level="DEBUG"/>
<AsyncLogger name="org.asynchttpclient" level="DEBUG"/>
---

==Debugging Projects that Use the HTTP Connector

To debug projects that use the HTTP connector, you might want to make the logging more verbose than usual and track all of the behavior of both the http-listener and http-request connectors in your project. See xxx for information.

== Request and Response Logging for SOAP

One common requirement during development is to be able to log both request and response, raw, for web services calls, especially for SOAP calls.
To handle this:

//. In Anypoint Studio,

. Open the `log4j2.xml` file in `src/main/resources` and add the HttpMessageLogger to the config:
+
[source,xml,linenums]
----
<!-- HTTP is used by Mule for dispatching to web services -->
<AsyncLogger name="org.mule.service.http.impl.service.HttpMessageLogger" level="DEBUG" />
----
+
. Save your project.

== Troubleshooting Logging

*I don't see any logging output*

Set the `log4j2.xml` at the root of your classpath. For more information about configuring log4j2, see Apache's https://logging.apache.org/log4j/2.x/[website].

*I reconfigured log4j2, but nothing happened*

This happens because there is another `log4j2.xml` file on your classpath that is getting picked up before your modified one. To find out which configuration file log4j2 is using, add the following switch when starting Mule (or to the container startup script if you are embedding Mule):

----
-M-Dlog4j.debug=true
----

This parameter writes the log4j2 startup information, including the location of the configuration file being used, to `stdout`. You must remove that configuration file before your modified configuration can work.
