= Message Enricher
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:keywords: studio, mule, esb, enrich, flow control

One common scenario involves the need to enrich an incoming message with information that isn’t provided by the source system. You can use a content enricher if the target system needs more information than the source system can provide.

Consider a message from a source system contains a zip code but the target system needs the two letter state. A message enricher can be used to lookup the state using the zip code from an enrichment resource. The enricher calls out to the enrichment resource with the current message (containing the zip code) then enriches the current message with the result.

[source,xml,linenums]
----
<flow name="orderProcessingFlow">
   <inbound-endpoint ref="orderEndpoint"/>
   <enricher target="#[variable:state]">
       <outbound-endpoint ref="stateLookup"/>
   </enricher>
   <outbound-endpoint ref="orderStep2"/>
</flow>
----

This is a very simple flow with one-way inbound and outbound endpoints, and which acts as part of an order processing pipeline. This flow uses an enricher to add a state _flow variable_ to the current message with the state that the `stateLookup` endpoint returns.  The ‘target’ attribute defines how the current message is enriched using a `MessageEnricher` which uses the same syntax as expression evaluators.

*Notes:*

* Mule currently supports enrichment of _flow variables_ and message headers only.
* Even though the Message Enricher receives a copy of the Mule message, the payload is not copied.
In other words, if the payload of your message is a mutable object (for example a bean with different fields in it) and a message processor in your Message Enricher changes the value of one of the fields, the message processors outside of the Message Enricher only see the changed values.

== More Complex Enrichment

In this particular example the 'addressLookup' endpoint receives the full message, in some cases this might be a generic service that doesn’t know how to parse our order message but rather just a zip string. It is very easy to improve the configuration to support this, consider the following snippet:

[source,xml,linenums]
----
<flow name="orderProcessingFlow">
   <inbound-endpoint ref="orderconnector"/>
   <enricher target="#[variable:address]">
       <outbound-endpoint ref="addressLookup">
           <expression-transformer evaluator="xpath" expression="/order/address/zip" />
       </outbound-endpoint>
   </enricher>
   <outbound-endpoint ref="orderStep2"/>
</flow>
----

The “enrichment resource” can be any message processor, outbound connector, processor-chain or flow-ref.  If using an outbound-connector then of course it should have a `request-responseexchange` pattern.

== More Advanced Examples

The *enricher* element also supports more advanced use cases where the message returned by the enrichment resource isn’t just a simple string which is exactly what we need to enrich the current message with, often you may want to enrich your message with just part of the information from the result of the invocation of an external service.

For example, if you have a requirement to validate the credit card used for the order as well as add the full address using the ZIP code.  The credit card validation process should populate a header call “paymentValidated” with either true or false, this will be used later on.  We can easily perform credit card validation by calling out to an authorization service like Authorize.Net to perform this validation, but we have a problem this cloud connector returns more than just a boolean.

The solution is to use the enrichers ‘source‘ attribute which will select a value from the result message before using it to enrich the target.

[source,xml,linenums]
----
<flow name="orderProcessingFlow">
   <inbound-endpoint ref="orderconnector"/>
   <enricher target="#[variable:paymentValidated]" source="/authorizenet/authorization/@valid">
       <authorizenet:authorize cardNumber="/order/cc/number" />
   </enricher>
   <outbound-endpoint ref="orderStep2"/>
</flow>
----

This approach allows you to map content in the response message from the enrichment resource to the current message.  If you have a more advanced use case you can also map `n` values in the enrichment resource response to m values enriched in the current message, this is done using child enricher elements each of which has source and target attributes.  Note: if you use child enricher elements the source/target attributes on enricher are not allowed.

[source,xml,linenums]
----
<flow name="orderProcessingFlow">
   <inbound-endpoint ref="orderconnector"/>
   <enricher>
       <authorizenet:authorize cardNumber="/order/cc/number" />
       <enrich target="#[variable:paymentValidated]" source="/authorizenet/authorization/@valid" />
       <enrich target="#[variable:paymentAuthCode]" source="/authorizenet/authorization/code"/>
   </enricher>
   <outbound-endpoint ref="orderStep2"/>
</flow>
----

== Variables and Enrichers

You can make the source a namespace by simply populating the field with a xref:mule-expression-language-mel.adoc[Mule Expression Language MEL] expression, for example with an xpath expression that takes arguments from the Mule message.

You can find information on using a variable with any enricher listed on these pages:

* xref:non-mel-expressions-configuration-reference.adoc[Default enrichers] are loaded at runtime
* Schema documentation for the http://www.mulesoft.org/docs/site/current/schemadocs/schemas/mule_xsd/elements/enricher.html[enricher element]
* API documents for https://www.mulesoft.org/docs/site/3.8.0/apidocs/org/mule/enricher/MessageEnricher.html[org.mule.core.enricher.MessageEnricher]

== Application Example
[source,xml,linenums]
----
<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns:tracking="http://www.mulesoft.org/schema/mule/ee/tracking" xmlns:json="http://www.mulesoft.org/schema/mule/json" xmlns:dw="http://www.mulesoft.org/schema/mule/ee/dw" 
xmlns:http="http://www.mulesoft.org/schema/mule/http" 
xmlns="http://www.mulesoft.org/schema/mule/core" 
xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
xmlns:spring="http://www.springframework.org/schema/beans" 
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-current.xsd
http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/dw http://www.mulesoft.org/schema/mule/ee/dw/current/dw.xsd
http://www.mulesoft.org/schema/mule/json http://www.mulesoft.org/schema/mule/json/current/mule-json.xsd
http://www.mulesoft.org/schema/mule/ee/tracking http://www.mulesoft.org/schema/mule/ee/tracking/current/mule-tracking-ee.xsd">
    <http:listener-config name="HTTP_Listener_Configuration" host="0.0.0.0" port="8081" doc:name="HTTP Listener Configuration"/>
    <flow name="message-enricher-flowVars-demonstration">
        <http:listener config-ref="HTTP_Listener_Configuration" path="/hello" doc:name="://localhost:8081/hello"/>
        <set-variable variableName="greeting" value="Hello" doc:name="Set initial value of the outer 'greeting' variable [Hello]"/>
        <logger message="Initial Greeting: [#[flowVars.greeting]]" level="INFO" doc:name="Log the value of the outer 'greeting' variable"/>
        <enricher target="#[flowVars.greeting]" doc:name="Message Enricher: Assign the value of modified inner 'greeting' variable [greeting + '!!!'] as the value of the outer 'greeting' variable" source="#[flowVars.greeting + &quot;!!!&quot;]">
            <processor-chain doc:name="Processor Chain">
                <set-variable variableName="greeting" value="#[flowVars.greeting + &quot; World&quot;]" doc:name="Create the inner 'greeting' variable and assign to it the value of the modified outer 'greeting' variable [greeting + ' World']"/>
                <dw:transform-message doc:name="Modify the value of the inner 'greeting' variable ['Oh, ' + greeting + ' Traveler']">
                    <dw:input-payload mimeType="application/java" />
                    <dw:set-variable variableName="greeting"><![CDATA[%dw 1.0
%output application/java
---
"Oh, " ++ flowVars.greeting ++ " Traveler"]]></dw:set-variable>
                </dw:transform-message>
                <set-payload value="#[42]" doc:name="Set Payload to any value [42]"/>
            </processor-chain>
        </enricher>
        <logger message="Value of payload: [#[payload]]" level="INFO" doc:name="Log the value of payload after Message Enricher [null]"/>
        <logger message="Final Greeting:   [#[flowVars.greeting]]" level="INFO" doc:name="Log the final value of the outer 'greeting' variable"/>
        <set-payload value="#[flowVars.greeting]" doc:name="Set the response payload to be the final value of the 'greeting' variable [Oh, Hello World Traveler!!!]"/>
        <logger message="Value of payload: [#[payload]]" level="INFO" doc:name="Log the value of payload [Oh, Hello World Traveler!!!]"/>
    </flow>
</mule>

----
